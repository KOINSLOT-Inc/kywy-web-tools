<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="KS Icon Black.png">
    <title>Drawing Editor - Kywy Image Tools</title>
    <link rel="stylesheet" href="drawing-editor-style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <div class="header-left">
                    <a href="menu.html" class="back-button">‚Üê Back to Menu</a>
                    <div class="brand-section">
                        <div class="ks-icon"></div>
                        <div class="brand-info">
                            <span class="brand-name">KOINSLOT</span>
                            <span class="app-name">Drawing Editor</span>
                        </div>
                    </div>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="nav-actions desktop-nav">
                    <button id="helpBtn" class="nav-btn">‚ùì Help</button>
                    <button id="importImageBtn" class="nav-btn">üñºÔ∏è Import</button>
                    <button id="clearCanvas" class="nav-btn">üóëÔ∏è Clear</button>
                    <button id="undoBtn" class="nav-btn" disabled title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
                    <button id="redoBtn" class="nav-btn" disabled title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
                    <button id="newBtn" class="nav-btn">New</button>
                    <button id="saveBtn" class="nav-btn">Save</button>
                    <button id="loadBtn" class="nav-btn">Load</button>
                    <input type="file" id="loadInput" accept=".json" style="display: none;">
                </div>
                
                <!-- Mobile Top Dropdowns -->
                <div class="mobile-top-bar">
                    <div class="mobile-dropdown">
                        <button class="mobile-dropdown-btn" id="mobileMenuDropdown">‚ò∞</button>
                        <div class="mobile-dropdown-content" id="mobileMainMenu">
                            <button id="mobileBackToMenu">üè† Back to Menu</button>
                            <button id="mobileHelpBtn">‚ùì Help</button>
                            <button id="mobileImportBtn">üñºÔ∏è Import</button>
                            <button id="mobileClearBtn">üóëÔ∏è Clear</button>
                            <button id="mobileUndoBtn">‚Ü∂ Undo</button>
                            <button id="mobileRedoBtn">‚Ü∑ Redo</button>
                            <button id="mobileNewBtn">üìÑ New</button>
                            <button id="mobileSaveBtn">üíæ Save</button>
                            <button id="mobileLoadBtn">üìÇ Load</button>
                            <button id="mobileThemeBtn">üé® Theme</button>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Panel Toggle Buttons -->
                <div class="mobile-panel-toggles">
                    <button class="mobile-panel-toggle" id="mobileToolsToggle">‚óÄ Left</button>
                    <button class="mobile-panel-toggle" id="mobileExportToggle">Right ‚ñ∂</button>
                </div>
            </div>
        </header>

        <div class="editor-layout">
            <!-- Left Sidebar Toggle -->
            <button class="sidebar-toggle left-toggle" id="leftToggle" title="Toggle Tools Panel">
                <span class="arrow">‚óÄ</span>
            </button>
            
            <!-- Left Sidebar - Tools -->
            <aside class="tools-panel" id="toolsPanel">
                <div class="tool-section">
                    <h3>Canvas Size</h3>
                    <select id="canvasSize">
                        <option value="8x8">8√ó8</option>
                        <option value="16x16">16√ó16</option>
                        <option value="32x32">32√ó32</option>
                        <option value="64x64">64√ó64</option>
                        <option value="128x128">128√ó128</option>
                        <option value="144x168" selected>144√ó168 (Kywy)</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div id="customSize" class="custom-size-inputs" style="display: none;">
                        <input type="number" id="customWidth" placeholder="Width" min="1" max="500" value="144">
                        <span>√ó</span>
                        <input type="number" id="customHeight" placeholder="Height" min="1" max="500" value="168">
                        <button id="applyCustomSize">Apply</button>
                    </div>
                </div>

                <div class="tool-group">
                    <h3>Tools</h3>
                    <div class="tools-grid">
                        <button class="tool-btn" data-tool="pen" title="Pen Tool (P)">‚úèÔ∏è Pen</button>
                        <button class="tool-btn" data-tool="hand" title="Pan Tool (H)">‚úã Hand</button>
                        <button class="tool-btn" data-tool="circle" title="Circle Tool (C)">‚≠ï Circle</button>
                        <button class="tool-btn" data-tool="square" title="Rectangle Tool (R)">üü• Rectangle</button>
                        <button class="tool-btn" data-tool="polygon" title="Polygon Tool (G)">‚¨¢ Polygon</button>
                        <button class="tool-btn" data-tool="bucket" title="Bucket Fill (F)">ü™£ Fill</button>
                        <button class="tool-btn" data-tool="text" title="Text Tool (T)">üî§ Text</button>
                        <button class="tool-btn" data-tool="select" title="Select Tool (S)">üî≤ Select</button>
                    </div>
                </div>

                <div class="tool-section" id="brushSettings">
                    <h3>Pen Color</h3>
                    <div class="color-picker">
                        <button id="blackColor" class="color-btn active" data-color="black">‚¨õ Black</button>
                        <button id="whiteColor" class="color-btn" data-color="white">‚¨ú White</button>
                    </div>
                    
                    <h4>Brush Settings</h4>
                    <label for="brushSize">Size: <span id="brushSizeDisplay">1</span>px</label>
                    <input type="range" id="brushSize" min="1" max="50" value="1">
                    
                    <div id="sprayFlowControl" style="display: none;">
                        <label for="sprayFlow">Flow: <span id="sprayFlowDisplay">3</span></label>
                        <input type="range" id="sprayFlow" min="1" max="10" value="3">
                    </div>
                    
                    <div class="brush-shape">
                        <span class="label-text">Shape:</span>
                        <div class="brush-shape-buttons">
                            <button id="squareBrush" class="brush-shape-btn active" data-shape="square">‚¨ú Square</button>
                            <button id="circleBrush" class="brush-shape-btn" data-shape="circle">‚≠ï Circle</button>
                        </div>
                    </div>
                    
                    <h4>Pen Mode</h4>
                    <div class="pen-mode-toggle">
                        <button id="penModeBtn" class="shape-mode-btn active" data-mode="freehand">
                            <span id="penModeIcon">‚úèÔ∏è</span>
                            <span id="penModeText">Freehand</span>
                        </button>
                    </div>
                </div>

                <div class="tool-section" id="selectionModeSection">
                    <h4>Selection Mode</h4>
                    <div class="selection-mode-toggle">
                        <button id="selectionModeBtn" class="shape-mode-btn active" data-mode="rectangle">
                            <span id="selectionModeIcon">‚ñ≠</span>
                            <span id="selectionModeText">Rectangle</span>
                        </button>
                    </div>
                </div>

                <div class="tool-section" id="editSettings" style="display: none;">
                    <h3>Edit</h3>
                    <button id="copyBtn" class="edit-btn">üìã Copy</button>
                    <button id="cutBtn" class="edit-btn">‚úÇÔ∏è Cut</button>
                    <button id="pasteModeBtn" class="edit-btn" disabled>üìã Paste Mode</button>
                    
                    <div id="pasteModeOptions" style="display: none; margin-top: 8px;">
                        <h4>Paste Options</h4>
                        <div style="margin-bottom: 8px;">
                            <span class="label-text" style="display: block; margin-bottom: 4px;">Transparency:</span>
                            <button id="transparencyToggle" class="edit-btn" style="font-size: 12px;">üîç Transparent White</button>
                        </div>
                    </div>
                    
                    <h4>Rotate Selection</h4>
                    <label for="rotationAngle">Angle: <span id="rotationAngleDisplay">0</span>¬∞</label>
                    <input type="range" id="rotationAngle" min="-180" max="180" value="0" step="5">
                    <div id="rotationWarning" style="display: none; color: #ff6b35; font-size: 11px; margin: 4px 0; padding: 2px 4px; background: rgba(255, 107, 53, 0.1); border-radius: 3px;">
                        ‚ö†Ô∏è Non-90¬∞ rotation is destructive to pixel art
                    </div>
                    <button id="rotateBtn" class="edit-btn">üîÑ Rotate</button>
                    
                    <h4>Mirror Selection</h4>
                    <button id="mirrorHorizontalBtn" class="edit-btn">‚¨å Mirror Horizontal</button>
                    <button id="mirrorVerticalBtn" class="edit-btn">‚¨ç Mirror Vertical</button>
                </div>

                <div class="tool-section" id="bucketSettings" style="display: none;">
                    <h3>Fill Color</h3>
                    <div class="color-picker">
                        <button id="bucketBlackColor" class="color-btn active" data-color="black">‚¨õ Black</button>
                        <button id="bucketWhiteColor" class="color-btn" data-color="white">‚¨ú White</button>
                    </div>
                    
                    <div class="fill-patterns-header">
                        <button id="fillPatternsToggle" class="collapsible-btn">üé® Fill Patterns</button>
                    </div>
                    <div id="fillPatternsSettings" class="frame-controls" style="display: none;">
                        <div class="fill-pattern-tools">
                            <h4>Pattern Type</h4>
                            <div class="pattern-grid">
                                <button class="pattern-btn" id="solidFill" data-pattern="solid" title="Solid Fill">‚¨õ Solid</button>
                                <button class="pattern-btn" id="percentageFill" data-pattern="percentage" title="Percentage Fill">‚ñ¶ %</button>
                                <button class="pattern-btn" id="checkerboard" data-pattern="checkerboard" title="Checkerboard">‚ñû Check</button>
                                <button class="pattern-btn" id="lines" data-pattern="lines" title="Adjustable Lines">‚â° Lines</button>
                                <button class="pattern-btn" id="clipboardPattern" data-pattern="clipboard" title="Clipboard Pattern">üìã Clip</button>
                                <button class="pattern-btn" id="dots" data-pattern="dots" title="Dot Pattern">‚ãÖ Dots</button>
                            </div>
                            
                            <div class="line-pattern-controls" id="linePatternControls" style="display: none; margin-top: 10px;">
                                <h4>Line Settings</h4>
                                <div class="line-controls">
                                    <div>
                                        <label for="lineAngle">Angle: <span id="lineAngleDisplay">0¬∞</span></label>
                                        <input type="range" id="lineAngle" min="0" max="180" value="0" step="0.01" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label for="lineSpacing">Spacing: <span id="lineSpacingDisplay">6px</span></label>
                                        <input type="range" id="lineSpacing" min="2" max="20" value="6" step="0.01" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label for="lineWidth">Width: <span id="lineWidthDisplay">1px</span></label>
                                        <input type="range" id="lineWidth" min="1" max="5" value="1" step="0.01" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label for="linePhase">Phase: <span id="linePhaseDisplay">0px</span></label>
                                        <input type="range" id="linePhase" min="0" max="20" value="0" step="0.01" style="width: 100%;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pattern-specific controls -->
                        <div class="percentage-pattern-controls" id="percentagePatternControls" style="display: none; margin-top: 10px;">
                            <h4>Percentage Settings</h4>
                            <div>
                                <label for="percentageFillSlider">Fill Amount: <span id="percentageDisplay">50</span>%</label>
                                <input type="range" id="percentageFillSlider" min="5" max="95" value="50" step="0.01" style="width: 100%;">
                            </div>
                        </div>

                        <div class="checkerboard-pattern-controls" id="checkerboardPatternControls" style="display: none; margin-top: 10px;">
                            <h4>Checkerboard Settings</h4>
                            <div>
                                <label for="checkerboardSize">Size: <span id="checkerboardSizeDisplay">2px</span></label>
                                <input type="range" id="checkerboardSize" min="1" max="8" value="2" step="0.01" style="width: 100%;">
                            </div>
                            <div class="control-row">
                                <label>
                                    <input type="checkbox" id="checkerboardInvert"> Invert Pattern
                                </label>
                            </div>
                        </div>

                        <div class="clipboard-pattern-controls" id="clipboardPatternControls" style="display: none; margin-top: 10px;">
                            <h4>Clipboard Settings</h4>
                            <div>
                                <label for="clipboardScale">Scale: <span id="clipboardScaleDisplay">100%</span></label>
                                <input type="range" id="clipboardScale" min="25" max="300" value="100" step="0.01" style="width: 100%;">
                            </div>
                            <div class="control-row">
                                <label>
                                    <input type="checkbox" id="clipboardInvert"> Invert Pattern
                                </label>
                            </div>
                        </div>

                        <div class="dots-pattern-controls" id="dotsPatternControls" style="display: none; margin-top: 10px;">
                            <h4>Dots Settings</h4>
                            <div>
                                <label for="dotsSpacing">Spacing: <span id="dotsSpacingDisplay">4px</span></label>
                                <input type="range" id="dotsSpacing" min="2" max="16" value="4" step="0.01" style="width: 100%;">
                            </div>
                            <div>
                                <label for="dotsSize">Size: <span id="dotsSizeDisplay">1px</span></label>
                                <input type="range" id="dotsSize" min="1" max="4" value="1" step="0.01" style="width: 100%;">
                            </div>
                            <div>
                                <label for="dotsOffset">Offset: <span id="dotsOffsetDisplay">50%</span></label>
                                <input type="range" id="dotsOffset" min="0" max="100" value="50" step="0.01" style="width: 100%;">
                            </div>
                            <div class="control-row">
                                <label>
                                    <input type="checkbox" id="dotsInvert"> Invert Pattern
                                </label>
                            </div>
                        </div>
                        
                        <div class="gradient-tools">
                            <h4>Gradients</h4>
                            <div class="gradient-grid">
                                <button class="pattern-btn" id="gradientLinear" data-pattern="gradient-linear" title="Linear Gradient">‚ïê Linear</button>
                                <button class="pattern-btn" id="gradientRadial" data-pattern="gradient-radial" title="Radial Gradient">‚óâ Radial</button>
                            </div>
                            
                            <div class="gradient-variant-controls" id="gradientVariantControls" style="display: none; margin-top: 10px;">
                                <h4>Gradient Style</h4>
                                <div class="gradient-grid">
                                    <button class="variant-btn" id="gradientStipple" data-variant="stipple" title="Stippled Gradient">‚ãÖ Stipple</button>
                                    <button class="variant-btn" id="gradientDither" data-variant="dither" title="Dithered Gradient">‚ñ¶ Dither</button>
                                </div>
                            </div>
                            
                            <div class="gradient-controls" id="gradientControls" style="display: none; margin-top: 10px;">
                                <div id="linearControls" style="display: none;">
                                    <h4>Linear Gradient Settings</h4>
                                    <label for="gradientAngle">Angle: <span id="angleDisplay">0</span>¬∞</label>
                                    <input type="range" id="gradientAngle" min="0" max="360" value="0" step="0.01">
                                    
                                    <label for="gradientSteepness">Steepness: <span id="steepnessDisplay">1.0</span></label>
                                    <input type="range" id="gradientSteepness" min="0.1" max="5.0" value="1.0" step="0.01">
                                    
                                    <label for="gradientPositionX">Position X: <span id="positionXDisplay">0.5</span></label>
                                    <input type="range" id="gradientPositionX" min="0" max="1" value="0.5" step="0.01">
                                    
                                    <label for="gradientPositionY">Position Y: <span id="positionYDisplay">0.5</span></label>
                                    <input type="range" id="gradientPositionY" min="0" max="1" value="0.5" step="0.01">
                                </div>
                                
                                <div id="radialControls" style="display: none;">
                                    <h4>Radial Gradient Settings</h4>
                                    <label for="radialRadius">Radius: <span id="radiusDisplay">0.7</span></label>
                                    <input type="range" id="radialRadius" min="0.1" max="2.0" value="0.7" step="0.01">
                                    
                                    <label for="radialPositionX">Center X: <span id="radialXDisplay">0.5</span></label>
                                    <input type="range" id="radialPositionX" min="0" max="1" value="0.5" step="0.01">
                                    
                                    <label for="radialPositionY">Center Y: <span id="radialYDisplay">0.5</span></label>
                                    <input type="range" id="radialPositionY" min="0" max="1" value="0.5" step="0.01">
                                </div>
                                
                                <div id="stippleDitherControls" style="display: none;">
                                    <h4>Stipple/Dither Settings</h4>
                                    <label for="gradientContrast">Contrast: <span id="contrastDisplay">1.0</span></label>
                                    <input type="range" id="gradientContrast" min="0.1" max="2.0" value="1.0" step="0.01">
                                    
                                    <label for="gradientBrightness">Brightness: <span id="gradientBrightnessDisplay">0</span></label>
                                    <input type="range" id="gradientBrightness" min="-100" max="100" value="0" step="0.01">
                                    
                                    <div class="control-row">
                                        <label>
                                            <input type="checkbox" id="gradientInvert"> Invert Gradient
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tool-section" id="shapeSettings" style="display: none;">
                    <h3>Shape Color</h3>
                    <div class="color-picker">
                        <button id="shapeBlackColor" class="color-btn active" data-color="black">‚¨õ Black</button>
                        <button id="shapeWhiteColor" class="color-btn" data-color="white">‚¨ú White</button>
                    </div>
                    
                    <h4>Fill Style</h4>
                    <div class="fill-style">
                        <button id="outlineOnly" class="fill-btn active" data-fill="outline">‚¨ú Outline</button>
                        <button id="filledShape" class="fill-btn" data-fill="filled">‚¨õ Filled</button>
                    </div>
                    
                    <h4>Mode</h4>
                    <div class="shape-mode-toggle">
                        <button id="shapeModeToggle" class="shape-mode-btn" title="Click to cycle through drawing modes">
                            <span id="shapeModeIcon">üìê</span>
                            <span id="shapeModeText">Corner</span>
                        </button>
                    </div>
                    
                    <div id="shapeThickness" class="thickness-section">
                        <h4>Stroke Thickness</h4>
                        <label for="shapeThicknessSlider">Width: <span id="shapeThicknessDisplay">1</span>px</label>
                        <input type="range" id="shapeThicknessSlider" min="1" max="50" value="1">
                        
                        <span class="label-text">Position:</span>
                        <div class="thickness-style">
                            <button id="outsideStyle" class="style-btn active" data-style="outside">‚ä° Out</button>
                            <button id="insideStyle" class="style-btn" data-style="inside">‚äû In</button>
                            <button id="centeredStyle" class="style-btn" data-style="centered">‚äü Center</button>
                        </div>
                    </div>
                </div>

                <div class="tool-section" id="polygonSettings" style="display: none;">
                    <h3>Polygon Color</h3>
                    <div class="color-picker">
                        <button id="polygonBlackColor" class="color-btn active" data-color="black">‚¨õ Black</button>
                        <button id="polygonWhiteColor" class="color-btn" data-color="white">‚¨ú White</button>
                    </div>
                    
                    <h4>Sides</h4>
                    <label for="polygonSides">Count: <span id="polygonSidesDisplay">6</span> sides</label>
                    <input type="range" id="polygonSides" min="2" max="20" value="6" step="1">
                    
                    <h4>Fill Style</h4>
                    <div class="fill-style">
                        <button id="polygonOutlineOnly" class="fill-btn active" data-fill="outline">‚¨ú Outline</button>
                        <button id="polygonFilledShape" class="fill-btn" data-fill="filled">‚¨õ Filled</button>
                    </div>
                    
                    
                    <div id="polygonThickness" class="thickness-section">
                        <h4>Stroke Thickness</h4>
                        <label for="polygonThicknessSlider">Width: <span id="polygonThicknessDisplay">1</span>px</label>
                        <input type="range" id="polygonThicknessSlider" min="1" max="50" value="1">
                    </div>
                </div>

                <div class="tool-section" id="textSettings" style="display: none;">
                    <h3>Text Color</h3>
                    <div class="color-picker">
                        <button id="textBlackColor" class="color-btn active" data-color="black">‚¨õ Black</button>
                        <button id="textWhiteColor" class="color-btn" data-color="white">‚¨ú White</button>
                    </div>
                    
                    <h4>Text Settings</h4>
                    <div class="text-controls">
                        <label for="textInput">Text:</label>
                        <textarea id="textInput" placeholder="Enter text... (use Enter for new lines)" maxlength="500" rows="3"></textarea>
                        
                        <div class="emoji-section">
                            <div id="emojiPicker" class="emoji-picker">
                                <div class="emoji-categories">
                                    <button class="emoji-cat-btn active" data-category="food">üçï</button>
                                    <button class="emoji-cat-btn" data-category="faces">üòÄ</button>
                                    <button class="emoji-cat-btn" data-category="nature">üå±</button>
                                    <button class="emoji-cat-btn" data-category="monsters">üëæ</button>
                                    <button class="emoji-cat-btn" data-category="activities">‚öΩ</button>
                                    <button class="emoji-cat-btn" data-category="travel">üöó</button>
                                    <button class="emoji-cat-btn" data-category="objects">üí°</button>
                                    <button class="emoji-cat-btn" data-category="symbols">‚ù§Ô∏è</button>
                                </div>
                                <div id="emojiGrid" class="emoji-grid">
                                    <!-- Emojis will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <label for="fontFamily">Font:</label>
                        <select id="fontFamily">
                            <!-- System fonts will be populated dynamically -->
                        </select>
                        
                        <label for="fontSize">Size: <span id="fontSizeDisplay">48</span>px</label>
                        <input type="range" id="fontSize" min="4" max="250" value="48" step="0.01">
                        
                        <div class="text-style">
                            <span class="label-text">Style:</span>
                            <button id="boldToggle" class="text-style-btn" data-style="bold">B Bold</button>
                            <button id="italicToggle" class="text-style-btn" data-style="italic">I Italic</button>
                        </div>
                        
                        <div class="emoji-adjustments">
                            <span class="label-text">Emoji mode</span>
                            <button id="emojiDitheringToggle" class="emoji-dither-btn active">üîç Edge Detection</button>
                            
                            <div id="emojiBrightnessContainer">
                                <label for="emojiBrightness">Emoji Brightness: <span id="emojiBrightnessDisplay">-20</span></label>
                                <input type="range" id="emojiBrightness" min="-100" max="100" value="-20" step="0.01">
                            </div>
                            
                            <div id="ditheringOptionsContainer" style="display: none;">
                                <label for="emojiContrast">Emoji Contrast: <span id="emojiContrastDisplay">100</span>%</label>
                                <input type="range" id="emojiContrast" min="50" max="200" value="100" step="0.01">
                                
                                <label for="ditheringTypeSelect">Dithering Type:</label>
                                <select id="ditheringTypeSelect">
                                    <option value="floyd-steinberg">Floyd-Steinberg</option>
                                    <option value="atkinson">Atkinson</option>
                                    <option value="bilayer">Bilayer</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                                <div class="tool-section">
                    <div class="mirror-transform-header">
                        <button id="mirrorTransformToggle" class="collapsible-btn">ü™û Mirror & Transform</button>
                    </div>
                    <div id="mirrorTransformSettings" class="frame-controls" style="display: none;">
                        <div class="mirror-tools">
                            <h4>Mirror Drawing</h4>
                            <div class="mirror-controls">
                                <button id="mirrorHorizontal" class="toggle-btn">‚ÜîÔ∏è Horizontal</button>
                                <button id="mirrorVertical" class="toggle-btn">‚ÜïÔ∏è Vertical</button>
                            </div>
                        </div>
                        
                        <div class="transform-tools">
                            <h4>Canvas Transform</h4>
                            <div class="transform-grid">
                                <button class="transform-btn" id="flipHorizontal" title="Flip Canvas Horizontally">‚ÜîÔ∏è Flip H</button>
                                <button class="transform-btn" id="flipVertical" title="Flip Canvas Vertically">‚ÜïÔ∏è Flip V</button>
                                <button class="transform-btn" id="rotateLeft" title="Rotate Canvas 90¬∞ Left">‚Ü∫ Rotate L</button>
                                <button class="transform-btn" id="rotateRight" title="Rotate Canvas 90¬∞ Right">‚Üª Rotate R</button>
                                <button class="transform-btn" id="invertCanvas" title="Invert Canvas Colors">üîÑ Invert</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tool-section">
                    <div class="animation-toggle-header">
                        <button id="animationToggle" class="collapsible-btn">üé¨ Animation</button>
                    </div>
                    <div id="animationSettings" class="frame-controls" style="display: none;">
                        <div class="frame-info" style="margin-top: 12px">
                            Frame: <span id="currentFrame">1</span> / <span id="totalFrames">1</span>
                        </div>
                        <!-- Top Row: Frame Navigation & Management -->
                        <div class="frame-buttons-row1" style="margin-top: 12px;">
                            <button id="prevFrame" disabled title="Previous Frame">‚¨ÖÔ∏è</button>
                            <button id="nextFrame" disabled title="Next Frame">‚û°Ô∏è</button>
                            <button id="addFrame" title="Add Frame">‚ûï</button>
                            <button id="copyFrame" title="Copy Frame">üìã</button>
                        </div>
                        
                        <!-- Bottom Row: Frame Movement & Delete -->
                        <div class="frame-buttons-row2">
                            <button id="deleteFrame" disabled title="Delete Frame">üóëÔ∏è</button>
                            <button id="moveFrameLeft" title="Move Frame Left">‚¨ÖÔ∏èüìÑ</button>
                            <button id="moveFrameRight" title="Move Frame Right">üìÑ‚û°Ô∏è</button>
                        </div>
                        
                        <!-- Animation Playback Controls -->
                        <div class="animation-playback-controls">
                            <button id="playBtn">‚ñ∂Ô∏è Play</button>
                            <div class="animation-mode">
                                <button id="cycleMode" class="mode-btn active" data-mode="cycle">üîÑ Cycle</button>
                                <button id="boomerangMode" class="mode-btn" data-mode="boomerang">‚ÜîÔ∏è Boomerang</button>
                            </div>
                        </div>
                        
                        <div class="animation-speed-controls">
                            <label for="frameRate">Speed: <span id="frameRateDisplay">5</span> FPS</label>
                            <input type="range" id="frameRate" min="0.1" max="30" value="5" step="0.1">
                        </div>
                        <div class="onion-skin">
                            <button id="onionSkinToggle" class="toggle-btn">üëª Onion Skin</button>
                            <div id="onionOpacityContainer" style="display: none;">
                                <div class="onion-opacity-controls">
                                    <label for="onionOpacity">Opacity: <span id="onionOpacityDisplay">30</span>%</label>
                                    <input type="range" id="onionOpacity" min="10" max="80" value="30">
                                </div>
                                <div class="onion-mode-controls">
                                    <span class="label-text">Mode:</span>
                                    <div class="mode-buttons">
                                        <button id="onionModeBlackOnWhite" class="mode-btn active" data-mode="blackOnWhite">Black on White</button>
                                        <button id="onionModeWhiteOnBlack" class="mode-btn" data-mode="whiteOnBlack">White on Black</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Canvas Area -->
            <main class="canvas-area">
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="backgroundCanvas" class="canvas-layer"></canvas>
                        <canvas id="onionCanvas" class="canvas-layer"></canvas>
                        <canvas id="drawingCanvas" class="canvas-layer"></canvas>
                        <canvas id="overlayCanvas" class="canvas-layer"></canvas>
                    </div>
                </div>
                
                <div class="canvas-controls">
                    <div class="zoom-controls">
                        <button id="zoomOut">üîç-</button>
                        <span id="zoomLevel">400%</span>
                        <button id="zoomIn">üîç+</button>
                        <button id="actualSize" title="Zoom to actual physical size (1.5&quot; diagonal)">1:1</button>
                        <button id="fitToScreen">Fit</button>
                        <button id="centerCanvas">Center</button>
                    </div>
                    <div class="grid-controls">
                        <label>
                            <input type="checkbox" id="pixelGrid"> Grid
                        </label>
                        <label>
                            <input type="checkbox" id="layersEnabled"> Layers
                        </label>
                        <label>
                            <input type="checkbox" id="animationEnabled"> Animations
                        </label>
                        <label>
                            <input type="checkbox" id="scriptEditorEnabled"> Scripts
                        </label>
                    </div>
                    <div class="canvas-info">
                        <span id="canvasInfo">144√ó168</span>
                        <span id="mousePos">0, 0</span>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar Toggle -->
            <button class="sidebar-toggle right-toggle" id="rightToggle" title="Toggle Export Panel">
                <span class="arrow">‚ñ∂</span>
            </button>

            <!-- Right Sidebar - Export -->
            <aside class="export-panel" id="exportPanel">
                <div class="tool-section">
                    <h3>Export</h3>
                    <div class="export-options">
                        <label for="exportFormat">Format:</label>
                        <select id="exportFormat">
                            <option value="hpp">Single HPP</option>
                            <option value="animation">Animation HPP</option>
                            <option value="layers">Layered HPP</option>
                            <option value="png">PNG Image</option>
                        </select>
                    </div>
                    <div class="export-options">
                        <label for="assetName">Name:</label>
                        <input type="text" id="assetName" class="iphone-input" placeholder="my_image" value="my_image" maxlength="50">
                        <div id="nameWarning" class="name-warning" style="display: none;">
                            ‚ö†Ô∏è Invalid characters will be replaced with underscores
                        </div>
                    </div>
                    <div class="export-spacing"></div>
                    <button id="exportBtn" class="export-btn">üì§ Export</button>
                </div>

                <div class="tool-section">
                    <h3>Frame List</h3>
                    <div id="frameList" class="frame-thumbnails">
                        <div class="frame-thumb active" data-frame="0">
                            <canvas class="thumb-canvas"></canvas>
                            <span class="frame-label">Frame 1</span>
                        </div>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Code Output</h3>
                    <textarea id="codeOutput" readonly placeholder="Generated code will appear here..."></textarea>
                    <button id="copyCodeBtn" class="export-btn">üìã Copy Code</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json,.hpp,.png,.gif" style="display: none;">

    <!-- Help Modal -->
    <div id="helpModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé® Drawing Editor Help</h2>
                <span class="close" id="closeHelp">&times;</span>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>Welcome to the KYWY Graphics Editor</h3>
                    <p>This is a specialized pixel art editor designed for creating graphics for the <strong>KYWY device</strong> (144√ó168 monochrome display). 
                    The editor exports Arduino/C++ code that can be directly used in your KYWY projects.</p>
                    
                    <h4>üñ•Ô∏è Interface Overview:</h4>
                    <ul>
                        <li><strong>Left Panel (Tools):</strong> Your main drawing tools including pen, shapes, fill, selection, and text tools. 
                        Select colors (black/white), adjust brush size, and choose drawing modes here.</li>
                        
                        <li><strong>Center (Canvas):</strong> Your drawing area. Use mouse wheel to zoom, middle-click to pan. 
                        The canvas displays your current frame and shows helpful overlays like grid lines and onion skin.</li>
                        
                        <li><strong>Right Panel (Export & Frames):</strong> Export your artwork as Arduino code in various formats (Single Frame, Animation, or Layers). 
                        Below the export section is the frame list where you can manage animation frames, duplicate frames, and navigate through your animation.</li>
                        
                        <li><strong>Bottom Panel (Layers & Animation):</strong> Enable layers to work with multiple composited layers per frame. 
                        Animation controls let you preview animations, adjust frame rates, and enable onion skinning. Grid controls help with pixel-perfect alignment.</li>
                    </ul>
                    
                    <h4>üé¨ Basic Workflow:</h4>
                    <ol>
                        <li><strong>Start Drawing:</strong> Select a tool (press P for pen) and draw on the canvas</li>
                        <li><strong>Create Animation:</strong> Click "+ Add Frame" to create multiple frames for animation</li>
                        <li><strong>Use Layers (Optional):</strong> Check "Enable Layers" at the bottom to work with multiple layers per frame</li>
                        <li><strong>Export Code:</strong> Click "Generate Code" on the right panel to create Arduino/C++ code</li>
                        <li><strong>Copy & Use:</strong> Copy the generated code and paste it into your KYWY Arduino project</li>
                    </ol>
                    
                    <h4>üí° Pro Tips:</h4>
                    <ul>
                        <li>Use <strong>Ctrl+Wheel</strong> to quickly adjust brush size or polygon sides</li>
                        <li>Press <strong>F7</strong> to quickly toggle the layer panel on/off</li>
                        <li>Hold <strong>Shift</strong> while drawing with pen for straight lines</li>
                        <li>Use <strong>onion skin</strong> to see previous/next frames while animating</li>
                        <li>The <strong>grid</strong> helps align pixels - toggle it with the Grid checkbox</li>
                        <li>Import images and convert them to 1-bit graphics with various dithering options</li>
                        <li><strong>Layers</strong> support transparency modes (white or black transparent) for advanced compositing</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>ÔøΩüîß Tools</h3>
                    <div class="shortcut-grid">
                        <span class="key">P</span><span>Pen Tool (Freehand)</span>
                        <span class="key">L</span><span>Line Tool</span>
                        <span class="key">G</span><span>Grid Pen Mode</span>
                        <span class="key">S</span><span>Spray Tool</span>
                        <span class="key">C</span><span>Circle Tool</span>
                        <span class="key">R</span><span>Rectangle/Square Tool</span>
                        <span class="key">Y</span><span>Polygon Tool</span>
                        <span class="key">F</span><span>Fill/Bucket Tool</span>
                        <span class="key">E</span><span>Select Tool</span>
                        <span class="key">H or M</span><span>Hand Tool (Pan/Move)</span>
                        <span class="key">T</span><span>Text Tool</span>
                        <span class="key">B</span><span>Black Color</span>
                        <span class="key">W</span><span>White Color</span>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üé® Tool Modifiers</h3>
                    <div class="shortcut-grid">
                        <span class="key">1-9</span><span>Brush Size / Polygon Sides / Fill Mode</span>
                        <span class="key">Ctrl+Wheel</span><span>Change Brush Size / Polygon Sides / Text Size</span>
                        <span class="key">Shift+Drag</span><span>Draw Straight Line (Pen)</span>
                        <span class="key">Shift+Drag</span><span>Perfect Circle (from center)</span>
                        <span class="key">Shift+Drag</span><span>Perfect Square (from center)</span>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üìÅ File Operations</h3>
                    <div class="shortcut-grid">
                        <span class="key">Ctrl+N</span><span>New Drawing</span>
                        <span class="key">Ctrl+S</span><span>Save Drawing</span>
                        <span class="key">Ctrl+O</span><span>Open Drawing</span>
                        <span class="key">Del</span><span>Clear Canvas</span>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>‚úÇÔ∏è Edit Operations</h3>
                    <div class="shortcut-grid">
                        <span class="key">Ctrl+C</span><span>Copy Selection</span>
                        <span class="key">Ctrl+V</span><span>Paste Selection</span>
                        <span class="key">Ctrl+X</span><span>Cut Selection</span>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üé¨ Animation</h3>
                    <div class="shortcut-grid">
                        <span class="key">‚Üê</span><span>Previous Frame</span>
                        <span class="key">‚Üí</span><span>Next Frame</span>
                        <span class="key">Space</span><span>Play/Pause Animation</span>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üé® Layers</h3>
                    <div class="shortcut-grid">
                        <span class="key">F7</span><span>Toggle Layer Panel</span>
                        <span class="key">Ctrl+Shift+L</span><span>Add New Layer</span>
                        <span class="key">Ctrl+Shift+N</span><span>Add New Layer</span>
                        <span class="key">Ctrl+I</span><span>Toggle White/Black Transparency</span>
                        <span class="key">[</span><span>Select Previous Layer</span>
                        <span class="key">]</span><span>Select Next Layer</span>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üîç View Controls</h3>
                    <div class="shortcut-grid">
                        <span class="key">+</span><span>Zoom In</span>
                        <span class="key">-</span><span>Zoom Out</span>
                        <span class="key">0</span><span>Fit to Screen</span>
                        <span class="key">1</span><span>Actual Size (1:1 - Physical KYWY size)</span>
                        <span class="key">.</span><span>Center Canvas</span>
                        <span class="key">1-9</span><span>Set Brush Size</span>
                        <span class="key">Middle Click</span><span>Pan/Drag Canvas</span>
                        <span class="key">?</span><span>Show/Hide Help</span>
                    </div>
                    <p><em>Note: Max zoom is 10,000% for detailed pixel work. The "1:1" button shows the canvas at actual physical KYWY screen size (1.5" diagonal).</em></p>
                </div>
                
                <div class="help-section">
                    <h3>üåà Gradient Fill Behaviors</h3>
                    <p>The Fill Tool (F) supports advanced gradient patterns with intelligent preview system:</p>
                    
                    <h4>üìê Gradient Types:</h4>
                    <ul>
                        <li><strong>Linear Gradients:</strong> Straight-line transitions from one side to another</li>
                        <li><strong>Radial Gradients:</strong> Circular transitions from center outward</li>
                    </ul>
                    
                    <h4>üé® Gradient Styles:</h4>
                    <ul>
                        <li><strong>Stipple:</strong> Dotted pattern that creates visual gradients through spacing</li>
                        <li><strong>Dither:</strong> Checkered pattern for smooth gradient appearance</li>
                    </ul>
                    
                    <h4>‚öôÔ∏è Gradient Controls:</h4>
                    <ul>
                        <li><strong>Angle:</strong> Direction of linear gradients (0-360¬∞)</li>
                        <li><strong>Position:</strong> Center point for gradients (X/Y coordinates)</li>
                        <li><strong>Radius:</strong> Size of radial gradients</li>
                        <li><strong>Steepness:</strong> How sharp the gradient transition is</li>
                        <li><strong>Contrast:</strong> Controls stipple/dither density</li>
                    </ul>
                    
                    <h4>üëÅÔ∏è Smart Preview System:</h4>
                    <ul>
                        <li><strong>Red Editing Mode:</strong> When adjusting gradient settings, preview shows in red to indicate editing state</li>
                        <li><strong>Full Canvas Preview:</strong> When mouse is away from canvas, shows complete gradient effect</li>
                        <li><strong>Targeted Preview:</strong> When mouse is on canvas, shows exactly what area will be filled</li>
                        <li><strong>Persistent Preview:</strong> Red preview stays visible while editing until you interact with the canvas</li>
                        <li><strong>Live Updates:</strong> Preview updates instantly as you adjust any gradient setting</li>
                    </ul>
                    
                    <h4>üñ±Ô∏è Usage Tips:</h4>
                    <ul>
                        <li>Select gradient type (Linear/Radial) then choose style (Stipple/Dither)</li>
                        <li>Adjust settings while watching the red preview update in real-time</li>
                        <li>Move mouse over canvas to see exactly where the fill will be applied</li>
                        <li>Move mouse away from canvas to see the full gradient effect</li>
                        <li>Click when satisfied with the preview to apply the gradient fill</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üí° Tips</h3>
                    <ul>
                        <li>Hold Shift while drawing to draw straight lines</li>
                        <li>Circle tool: Normal = ellipse (corner to corner), Shift = circle (center to radius)</li>
                        <li>Rectangle tool: Normal = rectangle (corner to corner), Shift = square (center outward)</li>
                        <li>Use onion skinning to see previous/next frames</li>
                        <li>Export as Animation HPP for Kywy displays</li>
                        <li>Use selection tool to copy/move parts of your drawing</li>
                        <li>144√ó168 is the native Kywy display resolution</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üìö Layer System</h3>
                    <ul>
                        <li><strong>Enable Layers:</strong> Check "Enable Layers" to activate the layer system for advanced compositing</li>
                        <li><strong>Multiple Layers:</strong> Each frame can have multiple layers that are composited together</li>
                        <li><strong>Transparency Modes:</strong> Each layer (except Layer 0) can use white or black as transparent color</li>
                        <li><strong>Layer 0:</strong> The bottom layer is always opaque and shows fully - no transparency</li>
                        <li><strong>Upper Layers:</strong> Layers above the bottom use transparency to show through to layers below</li>
                        <li><strong>White Transparency:</strong> White pixels become transparent, black pixels are opaque</li>
                        <li><strong>Black Transparency:</strong> Black pixels become transparent, white pixels are opaque</li>
                        <li><strong>Toggle Transparency:</strong> Click the transparency button (‚ö™/‚ö´) or press Ctrl+I on current layer</li>
                        <li><strong>Layer Visibility:</strong> Toggle eye icon to show/hide layers without deleting them</li>
                        <li><strong>Solo Mode:</strong> Click S to view only one layer at a time for editing</li>
                        <li><strong>Merge Down:</strong> Combine current layer with the layer below it</li>
                        <li><strong>Copy to Frames:</strong> Duplicate a layer to multiple frames at once</li>
                        <li><strong>Export Layers:</strong> Use "Layers HPP" format to export each layer as separate bitmaps</li>
                        <li><strong>Undo Support:</strong> All layer operations (add, delete, merge, transparency changes) are undoable</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üíª Script API Reference</h3>
                    <p>The editor includes a powerful scripting system that allows you to programmatically create drawings, animations, and complex patterns. Scripts are executed through the Script Editor panel (check box on bottom bar). Note that it is possible to get into an infinite loop and lose your work!! Save before running scripts you have not tested before.</p>
                                    
                    <h4>‚úèÔ∏è Basic Drawing Functions:</h4>
                    <ul>
                        <li><strong>setPixel(x, y, color)</strong><br>
                            Draw a single pixel at coordinates</li>
                        <li><strong>drawLine(x1, y1, x2, y2, color)</strong><br>
                            Draw a line between two points</li>
                        <li><strong>drawRect(x, y, w, h, filled, color)</strong><br>
                            Draw a rectangle (filled or outline)</li>
                        <li><strong>drawCircle(x, y, radius, filled, color)</strong><br>
                            Draw a circle (filled or outline)</li>
                        <li><strong>drawEllipse(x, y, rx, ry, filled, color)</strong><br>
                            Draw an ellipse with horizontal/vertical radii</li>
                        <li><strong>drawPolygon(x, y, radius, sides, rotation, filled, color)</strong><br>
                            Draw a polygon (triangle, pentagon, etc.)</li>
                        <li><strong>drawText(text, x, y, color)</strong><br>
                            Draw text at position</li>
                        <li><strong>floodFill(x, y, color)</strong><br>
                            Fill a connected region with color</li>
                    </ul>
                    
                    <h4>üé® Canvas & Color Functions:</h4>
                    <ul>
                        <li><strong>getPixel(x, y)</strong><br>
                            Get color of pixel ('black', 'white', or 'transparent')</li>
                        <li><strong>setColor(color)</strong><br>
                            Set current drawing color ('black' or 'white')</li>
                        <li><strong>getColor()</strong><br>
                            Get current drawing color</li>
                        <li><strong>clear()</strong><br>
                            Clear entire canvas to white</li>
                        <li><strong>fillCanvas(color)</strong><br>
                            Fill entire canvas with specified color</li>
                        <li><strong>invert()</strong><br>
                            Invert all colors on canvas (black ‚Üî white)</li>
                        <li><strong>invertCanvas()</strong><br>
                            Invert canvas colors (same as invert())</li>
                        <li><strong>hFlipCanvas()</strong><br>
                            Flip canvas horizontally</li>
                        <li><strong>vFlipCanvas()</strong><br>
                            Flip canvas vertically</li>
                        <li><strong>lRotateCanvas()</strong><br>
                            Rotate canvas left (counter-clockwise, 90¬∞)</li>
                        <li><strong>rRotateCanvas()</strong><br>
                            Rotate canvas right (clockwise, 90¬∞)</li>
                        <li><strong>getWidth()</strong><br>
                            Get canvas width in pixels (144)</li>
                        <li><strong>getHeight()</strong><br>
                            Get canvas height in pixels (168)</li>
                    </ul>
                    
                    <h4>üé¨ Animation Functions:</h4>
                    <ul>
                        <li><strong>getCurrentFrame()</strong><br>
                            Get current frame index (0-based)</li>
                        <li><strong>setCurrentFrame(index)</strong><br>
                            Switch to specific frame</li>
                        <li><strong>getFrameCount()</strong><br>
                            Get total number of frames</li>
                        <li><strong>addFrame()</strong><br>
                            Create a new frame, returns frame index</li>
                        <li><strong>deleteFrame()</strong><br>
                            Delete current frame</li>
                        <li><strong>duplicateFrame()</strong><br>
                            Duplicate current frame, returns new index</li>
                    </ul>
                    
                    <h4>üìö Layer Functions:</h4>
                    <ul>
                        <li><strong>getCurrentLayer()</strong><br>
                            Get current layer index (0-based)</li>
                        <li><strong>setCurrentLayer(index)</strong><br>
                            Switch to specific layer</li>
                        <li><strong>getLayerCount()</strong><br>
                            Get total number of layers in current frame</li>
                        <li><strong>addLayer()</strong><br>
                            Create a new layer, returns layer index</li>
                        <li><strong>deleteLayer(index)</strong><br>
                            Delete layer by index</li>
                        <li><strong>setLayerVisibility(index, visible)</strong><br>
                            Show/hide layer (true/false)</li>
                        <li><strong>getLayerVisibility(index)</strong><br>
                            Check if layer is visible</li>
                        <li><strong>setLayerOpacity(index, transparency)</strong><br>
                            Set layer transparency mode ('white', 'black', 'default')</li>
                        <li><strong>getLayerOpacity(index)</strong><br>
                            Get layer transparency mode</li>
                    </ul>
                    <p><strong>Transparency Modes:</strong> 'white' = white pixels transparent, 'black' = black pixels transparent, 'default' = no transparency</p>
                    
                    <h4>‚úÇÔ∏è Selection & Clipboard Functions:</h4>
                    <ul>
                        <li><strong>selectRect(x1, y1, x2, y2)</strong><br>
                            Create rectangular selection</li>
                        <li><strong>clearSelection()</strong><br>
                            Remove current selection</li>
                        <li><strong>hasSelection()</strong><br>
                            Check if selection exists</li>
                        <li><strong>getSelection()</strong><br>
                            Get selection bounds {x1, y1, x2, y2}</li>
                        <li><strong>copySelection()</strong><br>
                            Copy selection to clipboard</li>
                        <li><strong>cutSelection()</strong><br>
                            Cut selection to clipboard</li>
                        <li><strong>paste(x, y)</strong><br>
                            Paste clipboard at position</li>
                        <li><strong>rotateSelection(degrees)</strong><br>
                            Rotate selection (-180 to 180)</li>
                        <li><strong>mirrorSelectionH()</strong><br>
                            Mirror selection horizontally</li>
                        <li><strong>mirrorSelectionV()</strong><br>
                            Mirror selection vertically</li>
                    </ul>
                    
                    <h4>üé® Fill Pattern Functions:</h4>
                    <ul>
                        <li><strong>setFillPattern(pattern)</strong><br>
                            Set fill pattern for shapes</li>
                        <li><strong>getFillPattern()</strong><br>
                            Get current fill pattern</li>
                    </ul>
                    <p><strong>Available patterns:</strong> 'solid', 'stipple25', 'stipple50', 'stipple75', 'checkerboard', 'diagonal', 'crosshatch', 'dots'</p>
                    
                    <h4>üî¢ Utility Functions:</h4>
                    <ul>
                        <li><strong>random(min, max)</strong><br>
                            Get random integer between min and max (inclusive)</li>
                        <li><strong>map(value, inMin, inMax, outMin, outMax)</strong><br>
                            Map value from one range to another</li>
                        <li><strong>constrain(value, min, max)</strong><br>
                            Limit value between min and max</li>
                    </ul>
                    
                    <h4>üì§ Output & Interaction Functions:</h4>
                    <ul>
                        <li><strong>print(...args)</strong><br>
                            Output messages to script console</li>
                        <li><strong>alert(...args)</strong><br>
                            Show popup alert dialog</li>
                        <li><strong>prompt(message, defaultValue)</strong><br>
                            Show text input dialog. Returns user input string or null if cancelled</li>
                        <li><strong>confirm(message)</strong><br>
                            Show yes/no confirmation dialog. Returns true/false</li>
                        <li><strong>onClick(callback)</strong><br>
                            Register click handler function(x, y)</li>
                        <li><strong>noTimeout()</strong><br>
                            Disable 15-second script timeout (use with caution! Save your work first!)</li>
                        <li><strong>new()</strong><br>
                            Create new drawing (clears all)</li>
                    </ul>
                    
                    <h4>‚ö†Ô∏è Important Notes:</h4>
                    <ul>
                        <li><strong>Colors:</strong> Only 'black' and 'white' are supported (monochrome display)</li>
                        <li><strong>Coordinates:</strong> Origin (0,0) is top-left corner</li>
                        <li><strong>Bounds:</strong> Canvas is 144√ó168 pixels (KYWY display size)</li>
                        <li><strong>Animation Pause:</strong> Animations automatically pause during script execution</li>
                        <li><strong>Undo Support:</strong> Entire script execution is one undo operation</li>
                        <li><strong>Layer System:</strong> Scripts can work with layers when enabled</li>
                        <li><strong>Click Handlers:</strong> Only one click handler can be active at a time</li>
                        <li><strong>Script Timeout:</strong> Scripts automatically timeout after 15 seconds to prevent browser freezing</li>
                        <li><strong>Dialog Timeout:</strong> Time spent in alert(), prompt(), and confirm() dialogs does not count toward the 15-second timeout</li>
                        <li><strong>Timeout Bypass:</strong> Call <code>kde.noTimeout()</code> to disable timeout for long-running scripts (use with caution!)</li>
                        <li><strong>Error Handling:</strong> Script errors are shown in console and stop execution</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Importer Modal -->
    <div id="imageImportModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Image</h3>
                <span class="close" onclick="document.getElementById('imageImportModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div class="import-section">
                    <h4>Upload Image</h4>
                    <input type="file" id="importImageInput" accept="image/*">
                    <div id="importOriginalImage"></div>
                </div>

                <div class="import-section">
                    <h4>Settings</h4>
                    
                    <div class="setting-row">
                        <label for="importResize">Resize:</label>
                        <select id="importResize">
                            <option value="">Keep original size</option>
                            <option value="16x16">16x16</option>
                            <option value="32x32">32x32</option>
                            <option value="64x64">64x64</option>
                            <option value="128x64">128x64</option>
                            <option value="128x128">128x128</option>
                            <option value="144x168">144x168 (KYWY screen)</option>
                            <option value="custom">Custom size</option>
                        </select>
                        <div id="importCustomSize" style="display: none;">
                            <input type="number" id="importCustomWidth" placeholder="Width" min="1" max="1000">
                            x
                            <input type="number" id="importCustomHeight" placeholder="Height" min="1" max="1000">
                        </div>
                    </div>

                    <div class="setting-row">
                        <label>
                            <input type="checkbox" id="importInvert">
                            Invert colors
                        </label>
                        <label>
                            <input type="checkbox" id="importEdgeDetection">
                            Edge detection
                        </label>
                    </div>

                    <div class="setting-row">
                        <label for="importDithering">Dithering:</label>
                        <select id="importDithering">
                            <option value="none">None</option>
                            <option value="floyd-steinberg">Floyd-Steinberg</option>
                            <option value="atkinson">Atkinson</option>
                            <option value="ordered">Ordered (Bayer)</option>
                        </select>
                    </div>

                    <div class="setting-row">
                        <label for="importContrast">Contrast:</label>
                        <input type="range" id="importContrast" min="-100" max="100" value="0" step="0.01">
                        <span id="importContrastValue">0</span>
                    </div>

                    <div class="setting-row">
                        <label for="importBrightness">Brightness:</label>
                        <input type="range" id="importBrightness" min="-100" max="100" value="0" step="0.01">
                        <span id="importBrightnessValue">0</span>
                    </div>

                    <div class="setting-row">
                        <label for="importThreshold">Threshold:</label>
                        <input type="range" id="importThreshold" min="0" max="255" value="128" step="0.01">
                        <span id="importThresholdValue">128</span>
                    </div>

                    <div class="setting-row">
                        <label for="importPosition">Position:</label>
                        <select id="importPosition">
                            <option value="center">Center</option>
                            <option value="top-left">Top Left</option>
                            <option value="top-right">Top Right</option>
                            <option value="bottom-left">Bottom Left</option>
                            <option value="bottom-right">Bottom Right</option>
                        </select>
                    </div>
                </div>

                <div class="import-section">
                    <h4>Preview</h4>
                    <div id="importProcessedImage"></div>
                </div>

                <div class="modal-footer">
                    <button id="importToCanvas" class="btn btn-primary" disabled>Import to Canvas</button>
                    <button id="importToPaste" class="btn btn-primary" disabled>Import to Paste Mode</button>
                    <button onclick="document.getElementById('imageImportModal').style.display='none'" class="btn">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Footer Branding -->
        <footer class="app-footer">
            <div class="footer-brand">
                <div class="ks-icon-small"></div>
                <span>Powered by KOINSLOT</span>
            </div>
        </footer>
    </div>

    <!-- Copy Layer to Frames Modal -->
    <div id="copyLayerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Copy Layer to Frames</h2>
                <span class="close" onclick="document.getElementById('copyLayerModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <p id="copyLayerModalText" style="margin-bottom: 15px; font-weight: 500;">Select frames to copy "<span id="copyLayerName"></span>" to:</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="selectAllFrames" class="btn" style="flex: 1;">Select All</button>
                    <button id="deselectAllFrames" class="btn" style="flex: 1;">Deselect All</button>
                </div>
                
                <div id="frameCheckboxList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: white;">
                    <!-- Frame checkboxes will be populated here by JavaScript -->
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="document.getElementById('copyLayerModal').style.display='none'" class="btn">Cancel</button>
                    <button id="confirmCopyLayer" class="btn" style="background: var(--primary-color); color: white;">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="mobile-overlay"></div>

    <!-- Mobile Popup Menus -->
    <div id="mobile-left-menu" class="mobile-popup mobile-left">
        <div class="mobile-menu-header">
            <h3>üõ†Ô∏è Tools & Settings</h3>
            <button class="mobile-close-btn">‚úï</button>
        </div>
        <div class="mobile-menu-content">
            <!-- Left sidebar content (tools, colors, etc.) will be dynamically populated -->
            <div class="mobile-section">
                <h4>Drawing Tools</h4>
                <!-- Tools content -->
            </div>
            <div class="mobile-section">
                <h4>Colors</h4>
                <!-- Color picker content -->
            </div>
            <div class="mobile-section">
                <h4>Brush Settings</h4>
                <!-- Brush settings content -->
            </div>
        </div>
    </div>

    <div id="mobile-right-menu" class="mobile-popup mobile-right">
        <div class="mobile-menu-header">
            <h3>üì§ Export & Actions</h3>
            <button class="mobile-close-btn">‚úï</button>
        </div>
        <div class="mobile-menu-content">
            <!-- Right sidebar content (export, frames, etc.) will be dynamically populated -->
            <div class="mobile-section">
                <h4>Animation</h4>
                <!-- Frame controls content -->
            </div>
            <div class="mobile-section">
                <h4>Export Options</h4>
                <!-- Export controls content -->
            </div>
            <div class="mobile-section">
                <h4>Canvas Tools</h4>
                <!-- Canvas transform tools -->
            </div>
        </div>
        </div>
    
    <!-- Layers Panel (bottom of screen) -->
    <div class="layers-panel" id="layersPanel" style="display: none;">
        <div class="layers-header">
            <h3>üìö Layers</h3>
            <div class="layers-actions">
                <button id="addLayer" class="layer-btn" title="Add Layer">‚ûï Add</button>
                <button id="deleteLayer" class="layer-btn" title="Delete Layer">üóëÔ∏è</button>
                <button id="moveLayerLeft" class="layer-btn" title="Move Layer Left">‚¨ÖÔ∏è</button>
                <button id="moveLayerRight" class="layer-btn" title="Move Layer Right">‚û°Ô∏è</button>
                <button id="mergeDown" class="layer-btn" title="Merge with Layer Below">‚¨ÖÔ∏è Merge Left</button>
                <button id="copyLayerToFrames" class="layer-btn" title="Copy Layer to Other Frames">üìã Copy to Frames</button>
            </div>
        </div>
        <div class="layers-list" id="layersList">
            <!-- Layers will be added here dynamically -->
        </div>
    </div>

    <!-- Animation Panel (bottom of screen) -->
    <div class="animation-panel" id="animationPanel" style="display: none;">
        <div class="animation-header">
            <h3>üé¨ Animation</h3>
            <div class="animation-actions">
                <button id="animAddFrame" class="animation-btn" title="Add Frame">‚ûï Add</button>
                <button id="animDeleteFrame" class="animation-btn" title="Delete Frame">üóëÔ∏è</button>
                <button id="animMoveLeft" class="animation-btn" title="Move Frame Left">‚¨ÖÔ∏è</button>
                <button id="animMoveRight" class="animation-btn" title="Move Frame Right">‚û°Ô∏è</button>
                <button id="animCopyFrame" class="animation-btn" title="Copy Frame">üìã Copy</button>
                <button id="animPlayBtn" class="animation-btn" title="Play Animation">‚ñ∂Ô∏è Play</button>
                <div class="animation-mode-controls">
                    <button id="animCycleMode" class="mode-btn active" data-mode="cycle">üîÑ Cycle</button>
                    <button id="animBoomerangMode" class="mode-btn" data-mode="boomerang">‚ÜîÔ∏è Boomerang</button>
                </div>
                <div class="animation-speed-control">
                    <label for="animFrameRate">Speed: <span id="animFrameRateDisplay">5</span> FPS</label>
                    <input type="range" id="animFrameRate" min="0.1" max="30" value="5" step="0.1">
                </div>
                <div class="onion-skin-control">
                    <button id="animOnionSkinToggle" class="toggle-btn">üëª Onion Skin</button>
                    <div id="animOnionOpacityContainer" style="display: none;">
                        <button id="animOnionOpacityDecrease" class="mode-btn">-</button>
                        <span id="animOnionOpacityDisplay" class="opacity-display">30%</span>
                        <button id="animOnionOpacityIncrease" class="mode-btn">+</button>
                        <button id="animOnionModeToggle" class="mode-btn active" data-mode="blackOnWhite">B/W</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="frames-list" id="framesList">
            <!-- Frames will be added here dynamically -->
        </div>
    </div>
    
    <!-- Script Editor Panel (bottom of screen) -->
    <div class="script-editor-panel" id="scriptEditorPanel" style="display: none;">
        <div class="script-editor-header">
            <h3>üíª Script Editor</h3>
            <div class="script-editor-actions">
                <select id="scriptExamples" class="script-examples-select">
                    <option value="">-- Load Example --</option>
                    <option value="kdeReference">Code Reference</option>
                    <option value="bresenham">Bresenham's Circle</option>
                    <option value="spiral">Spiral Pattern</option>
                    <option value="grid">Grid Pattern</option>
                    <option value="checkerboard">Checkerboard</option>
                    <option value="circle">Concentric Circles</option>
                    <option value="random">Random Pixels</option>
                    <option value="interactive">Interactive Click Drawing</option>
                    <option value="animation">Multi-Frame Animation</option>
                    <option value="layers">Multi-Layer Drawing</option>
                    <option value="selection">Selection Operations</option>
                </select>
                <button id="runScriptBtn" class="script-btn" title="Run Script">‚ñ∂Ô∏è Run</button>
                <button id="fullscreenScriptBtn" class="script-btn" title="Toggle Fullscreen">‚õ∂ Fullscreen</button>
                <div class="script-output" id="scriptOutput" style="display: none;"></div>
            </div>
        </div>
        <div class="script-editor-content">
            <div id="codeEditorContainer" class="code-editor-wrapper">
                <!-- CodeMirror will be initialized here -->
                <textarea id="scriptInput" class="script-textarea" spellcheck="false" style="display: block;">// Welcome to KYWY Drawing Editor Scripts!
// Here you can programmatically create drawings and animations using javascript.
// The 'kde' object provides access to the canvas and drawing functions.
// Becareful though, it is possible to lose your work when you runscripts so be sure the save your work!
// See the full API reference in the Help panel (top bar) or load the "Code Reference" example from the dropdown.
//
// Bresenham's Circle Algorithm
// This algorithm is a classic method for drawing circles in computer graphics.
kde.clear();

function bresenhamCircle(cx, cy, radius) {
  let x = 0;
  let y = radius;
  let d = 3 - 2 * radius;
  
  // Draw 8 symmetric points
  function drawCirclePoints(cx, cy, x, y) {
    kde.setPixel(cx + x, cy + y);
    kde.setPixel(cx - x, cy + y);
    kde.setPixel(cx + x, cy - y);
    kde.setPixel(cx - x, cy - y);
    kde.setPixel(cx + y, cy + x);
    kde.setPixel(cx - y, cy + x);
    kde.setPixel(cx + y, cy - x);
    kde.setPixel(cx - y, cy - x);
  }
  
  drawCirclePoints(cx, cy, x, y);
  
  while (y >= x) {
    x++;
    
    if (d > 0) {
      y--;
      d = d + 4 * (x - y) + 10;
    } else {
      d = d + 4 * x + 6;
    }
    
    drawCirclePoints(cx, cy, x, y);
  }
}

// Draw multiple concentric circles
const centerX = kde.getWidth() / 2;
const centerY = kde.getHeight() / 2;

for (let r = 10; r <= 60; r += 10) {
  bresenhamCircle(centerX, centerY, r);
}</textarea>
            </div>
        </div>
    </div>
    
    <!-- Mobile Bottom Bar -->
    <div class="mobile-bottom-bar">
        <div class="mobile-bottom-controls">
            <!-- Grid Toggle -->
            <button class="mobile-control-btn" id="mobileGridBtn" title="Toggle Grid">
                <span>üìê</span>
            </button>
            
            <!-- Zoom Controls -->
            <div class="mobile-zoom-group">
                <button class="mobile-control-btn" id="mobileZoomOut" title="Zoom Out">‚àí</button>
                <span class="mobile-zoom-display" id="mobileZoomDisplay">100%</span>
                <button class="mobile-control-btn" id="mobileZoomIn" title="Zoom In">+</button>
            </div>
            
            <!-- View Controls -->
            <button class="mobile-control-btn" id="mobileFitBtn" title="Fit to Screen">‚§¢</button>
            <button class="mobile-control-btn" id="mobileCenterBtn" title="Center Canvas">üéØ</button>
            
            <!-- Mouse Position -->
            <span class="mobile-mouse-pos" id="mobileMousePos">0, 0</span>
        </div>
    </div>
    
    <!-- Tool Settings Popup -->
    <div class="tool-settings-popup" id="toolSettingsPopup" style="display: none;">
        <div class="tool-settings-header">
            <h3>Tool Settings</h3>
            <button class="close-popup-btn" id="closeToolSettings">√ó</button>
        </div>
        <div class="tool-settings-content" id="toolSettingsContent">
            <!-- Content will be populated dynamically based on selected tool -->
        </div>
    </div>

    <!-- CodeMirror 5 for syntax highlighting (classic version, more stable) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>

    <script src="theme-switcher.js"></script>
    <script src="drawing-editor.js"></script>
</body>
</html>
