<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/png" href="KS Icon Black.png">
    <title>WebUSB Test for KYWY</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 5px; }
        #status { margin: 10px 0; padding: 10px; background: #f0f0f0; min-height: 20px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>WebUSB Test for KYWY Devices</h1>
    
    <div>
        <button onclick="checkWebUSBSupport()">Check WebUSB Support</button>
        <button onclick="listDevices()">List Connected Devices</button>
        <button onclick="requestDevice()">Request RP2040 Device</button>
        <button onclick="testConnection()">Test Device Connection</button>
    </div>
    
    <div id="status">Click a button to start testing...</div>
    
    <script>
        let selectedDevice = null;
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            status.appendChild(div);
            console.log(message);
        }
        
        async function checkWebUSBSupport() {
            log('Checking WebUSB support...');
            
            if (!('usb' in navigator)) {
                log('WebUSB is not supported in this browser', 'error');
                return false;
            }
            
            log('WebUSB is supported!', 'success');
            
            // Check if we're on HTTPS (required for WebUSB)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                log('Warning: WebUSB requires HTTPS (except on localhost)', 'error');
                return false;
            }
            
            log('Protocol check passed', 'success');
            return true;
        }
        
        async function listDevices() {
            if (!(await checkWebUSBSupport())) return;
            
            try {
                log('Getting previously authorized devices...');
                const devices = await navigator.usb.getDevices();
                
                if (devices.length === 0) {
                    log('No previously authorized devices found');
                } else {
                    log(`Found ${devices.length} authorized device(s):`);
                    devices.forEach((device, i) => {
                        log(`  Device ${i+1}: VID:${device.vendorId.toString(16).padStart(4, '0').toUpperCase()} PID:${device.productId.toString(16).padStart(4, '0').toUpperCase()}`);
                        if (device.vendorId === 0x2e8a) {
                            log(`    â†’ This is a Raspberry Pi device!`, 'success');
                        }
                    });
                }
            } catch (err) {
                log(`Error listing devices: ${err.message}`, 'error');
            }
        }
        
        async function requestDevice() {
            if (!(await checkWebUSBSupport())) return;
            
            try {
                log('Requesting RP2040/RP2350 device...');
                
                // Filter for Raspberry Pi devices
                const filters = [
                    { vendorId: 0x2e8a, productId: 0x0003 }, // Pico
                    { vendorId: 0x2e8a, productId: 0x000a }, // Pico W
                    { vendorId: 0x2e8a } // Other RP devices
                ];
                
                selectedDevice = await navigator.usb.requestDevice({ filters });
                
                log(`Device selected: VID:${selectedDevice.vendorId.toString(16).padStart(4, '0').toUpperCase()} PID:${selectedDevice.productId.toString(16).padStart(4, '0').toUpperCase()}`, 'success');
                
                if (selectedDevice.productName) {
                    log(`Product name: ${selectedDevice.productName}`);
                }
                if (selectedDevice.manufacturerName) {
                    log(`Manufacturer: ${selectedDevice.manufacturerName}`);
                }
                if (selectedDevice.serialNumber) {
                    log(`Serial: ${selectedDevice.serialNumber}`);
                }
                
            } catch (err) {
                if (err.name === 'NotFoundError') {
                    log('No compatible device found or user cancelled selection', 'error');
                } else {
                    log(`Error requesting device: ${err.message}`, 'error');
                }
            }
        }
        
        async function testConnection() {
            if (!selectedDevice) {
                log('No device selected. Click "Request RP2040 Device" first.', 'error');
                return;
            }
            
            try {
                log('Testing device connection...');
                
                if (!selectedDevice.opened) {
                    log('Opening device...');
                    await selectedDevice.open();
                    log('Device opened successfully', 'success');
                }
                
                log(`Device configuration: ${selectedDevice.configuration?.configurationValue || 'none'}`);
                
                if (selectedDevice.configuration === null) {
                    log('Selecting configuration 1...');
                    await selectedDevice.selectConfiguration(1);
                    log('Configuration selected', 'success');
                }
                
                // List interfaces
                log('Available interfaces:');
                selectedDevice.configuration.interfaces.forEach((iface, i) => {
                    log(`  Interface ${i}: Class ${iface.interfaceClass}, Subclass ${iface.interfaceSubclass}`);
                    iface.alternate.endpoints.forEach((ep, j) => {
                        log(`    Endpoint ${j}: ${ep.direction} ${ep.type} (${ep.packetSize} bytes)`);
                    });
                });
                
                // Try to claim interface 0
                log('Attempting to claim interface 0...');
                await selectedDevice.claimInterface(0);
                log('Interface 0 claimed successfully!', 'success');
                
                log('Connection test completed successfully!', 'success');
                
                // Clean up
                await selectedDevice.releaseInterface(0);
                await selectedDevice.close();
                log('Device closed');
                
            } catch (err) {
                log(`Connection test failed: ${err.message}`, 'error');
                
                // Try to clean up
                try {
                    if (selectedDevice.opened) {
                        await selectedDevice.releaseInterface(0).catch(() => {});
                        await selectedDevice.close();
                    }
                } catch (_) {}
            }
        }
        
        // Auto-check WebUSB support on load
        window.addEventListener('load', () => {
            checkWebUSBSupport();
        });
    </script>
</body>
</html>
